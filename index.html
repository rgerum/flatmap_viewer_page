<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flatmap Viewer</title>
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.11/pako.min.js"></script>


    <script src="js/numpy_to_js.js"></script>
    <script src="js/flat_map.js"></script>
    <script src="js/update_image.js"></script>
    <script src="js/form_to_url.js"></script>


    <style>
        body {
            background: #151515;
            color: #c4c4c4;
            font-family: sans;
            margin: 10px;
        }
        #plotContainer {
            overflow: hidden;
            border: 1px solid black;
            /*width: 100%;
            height: 400px;*/
            position: relative;
            border-radius: 10px;
        }
        #plotImage {
            max-width: none;
            transform-origin: top left;
        }

        .grid {
            display: table;
        }
        .row {
            display: table-row;
        }
        .square {
            display: table-cell;
            width: 10px;
            height: 10px;
            border: 1px solid black;
            background: rgb(128, 128, 128);
        }
        .square_active {
            display: table-cell;
            width: 10px;
            height: 10px;
            border: 1px solid black;
            background: red;
        }
        #plotImage {
            position: relative;
        }
        .image_centering {
            margin: 0 auto;
            /*height: 119px;
            margin: 0 auto;
            display: block;*/
                display: flex;
                justify-content: center; /* Horizontally centers the image */
                align-items: center;     /* Vertically centers the image */
                height: 400px;           /* Adjust as needed */
                width: 300px;            /* Adjust as needed */
        }
        .image {
            position: absolute;
            //top: 0;
            //left: 0;
            max-height: 100%;


        }

        .check_list {
            display: flex;
            flex-wrap: wrap;
        }

        .check_list label {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.8em;
            padding-top: 13px;
        }
        .check_list span {
            transform: rotate(-90deg);
            height: 1em;
            width: 1em;
            text-align: right;
        }

        .check_list_rows {
            width: 277px;
            display: flex;
            flex-direction: column;
        }
        .check_list_rows label {
            display: flex;
            flex-direction: row;
        }

        #componentExamples {
            width: 100%;
            overflow-x: scroll;
            border-radius: 10px;
            background: #262626c9;
            min-height: 128px;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        #componentExamples div {
            display: flex;
        }

        .spinner {
            border: 8px solid rgba(255, 255, 255, 0.3); /* Light grey */
            border-radius: 50%; /* Circular shape */
            border-top: 8px solid #333; /* Dark grey */
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none; /* Hidden by default */
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        #clicked {
            position: absolute;
            background: #262626c9;
            padding: 5px;
            top: 5px;
            border-radius: 10px;
            left: 5px;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .control_box {
            background: #262626c9;
            padding: 7px;
            border-radius: 10px;
            overflow: hidden;
            /* margin: 5px; */
        }

        .main_column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control_box_title {
            background: #393939;
            width: 100%;
            display: block;
            margin: -10px -10px 0;
            padding: 10px 10px 5px;
            font-variant: small-caps;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        .row_title2 {
            position: relative; /* Make the box a position reference for the title */
            padding-left: 30px; /* Space for the rotated title */
            background: #393939;
        }

        .row_title2 div {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translate(4px, 50%) rotate(-90deg);
            transform-origin: top left;
            white-space: nowrap;
            padding-top: 0px;
        }

        input[type="number"], input[type="text"] {
            max-width: calc(100% - 10px);
        }

        .flex-row {
            display: flex;
            flex-direction: row;
            gap: 10px
        }
        .flex-row>div {
            width: 100%;
        }
        .round-corner {
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid black;
            background: #151515;
            position: relative;
        }


        .slidecontainer {
            width: 100px; /* Width of the outside container */
            max-width: 80%;
            position: absolute;
            bottom: 5px;
            left: 5px;
}

        .slider_marker {
            height: 8px;
              width: 1px;
              background: #bbb;
              position: absolute;
              top: 5px;
        }

/* The slider itself */
.slider {
  -webkit-appearance: none;  /* Override default CSS styles */
  appearance: none;
  width: 100%; /* Full-width */
  height: 8px; /* Specified height */
  background: #262626c9; /* Grey background */
  outline: none; /* Remove outline */
  opacity: 0.7; /* Set transparency (for mouse-over effects on hover) */
  -webkit-transition: .2s; /* 0.2 seconds transition on hover */
  transition: opacity .2s;
    border-radius: 10px;
}

/* Mouse-over effects */
.slider:hover {
  opacity: 1; /* Fully shown on mouse-over */
}

/* The slider handle (use -webkit- (Chrome, Opera, Safari, Edge) and -moz- (Firefox) to override default look) */
.slider::-webkit-slider-thumb {
  -webkit-appearance: none; /* Override default look */
  appearance: none;
  width: 13px; /* Set a specific slider handle width */
  height: 13px; /* Slider handle height */
  background: #242424; /* Green background */
  cursor: pointer; /* Cursor on hover */
}

.slider::-moz-range-thumb {
  width: 13px; /* Set a specific slider handle width */
  height: 13px; /* Slider handle height */
  background: #242424; /* Green background */
  cursor: pointer; /* Cursor on hover */
}


.slider_buttons {
	bottom: 30px;
	position: absolute;
	left: 10px;
}
    </style>
</head>
<body>
    <div id="grid"></div>
    <div class="main_column">
        <form id="plotForm" class="controls">
            <input type="hidden" name="show_groups" value="0"/>
            <div class="control_box">
                <span class="control_box_title">Layers</span>
                <br/>
                <div id="layer_ids" class="check_list_rows"></div>
            </div>
            <div class="control_box">
                <span class="control_box_title">Subjects</span>
                <div id="subject_ids" class="check_list"></div>
                Min Sub Overlap Count: <input type="number" name="min_subject_overlap_count" min="1" max="8" value="4" oninput="update_plot()">
            </div>
            <div class="control_box" id="box_components">
                <span class="control_box_title">Components</span>
                <div id="component_ids" class="check_list"></div>
                <input type="button" value="none" id="btn_select_none">
                <input type="button" value="all" id="btn_select_all">
                <label><span>show roi</span><input type="checkbox" value="on" id="show_roi" name="show_roi" checked onclick="toggle_roi()"></label>
                <input type="hidden" name="x" value="0"/>
                <input type="hidden" name="y" value="0"/>
                <input type="hidden" name="voxel" value="0"/>
            </div>

            <div class="control_box" id="box_concepts" style="display: none">
                <span class="control_box_title">Concepts</span>
                <br/>
                <input type="checkbox" name="show_component_ids2" value="0" checked onclick="update_plot()">
                <input type="text" value="3,26,77,101,108,119" name="component_ids2">
                <input type="checkbox" name="show_component_ids2" value="1" checked onclick="update_plot()">
                <input type="text" value="5,27,78,92" name="component_ids2">
                <input type="checkbox" name="show_component_ids2" value="2" checked onclick="update_plot()">
                <input type="text" value="3,27,92,101,108,115" name="component_ids2">
                <input type="checkbox" name="show_component_ids2" value="3" checked onclick="update_plot()">
                <input type="text" value="5,26,77,78,119" name="component_ids2">
            </div>
        </form>

        <div class="flex-row">
            <div id="plotContainer">

                <div id="plotImage" style="cursor: auto">
                    <div class="image_centering">
                        <img src="static_data/background.png" id="plotImage1" alt="Generated Plot" class="image">
                        <canvas id="myCanvas" width="2274" height="1024" class="image"></canvas>
                        <img src="static_data/foreground.png" id="plotImage2" alt="Generated Plot" class="image">
                        <canvas id="myCanvasPoint" width="2274" height="1024"  class="image"></canvas>
                    </div>
                </div>
                <span id="clicked"></span>
                <span id="spinner" class="spinner"></span>
            </div>
            <div class="round-corner">
                <canvas id="plot3d"></canvas>
                <div class="slider_buttons">
                    <button class="slider_button" onclick="document.animateShapeChange(0)">0</button>
                    <button class="slider_button" onclick="document.animateShapeChange(100)">1</button>
                    <button class="slider_button" onclick="document.animateShapeChange(200)">2</button>
                    <button class="slider_button" onclick="document.animateShapeChange(300)">3</button>
                </div>
                <div class="slidecontainer">
                    <div class="slider_marker" style="left: 33%"></div>
                    <div class="slider_marker" style="left: 66%"></div>
                    <input type="range" class="slider" id="shape" name="shape" min="0" max="300" value="0" oninput="document.set_shape(this.value)">
                </div>
            </div>
        </div>

        <div id="componentExamples">

        </div>
    </div>

    <script>
        let zoom_scale = 1;
        function toggle_roi() {
            let checkbox = document.getElementById("show_roi").checked;
            document.getElementById("plotImage2").style.display = checkbox ? "none" : "block";
        }

        fetch('static_data/all_component_ids.json', {}).then(function(response) {
            return response.json();
        }).then(function(init_data) {


        function get_form_data() {
            const form = document.getElementById("plotForm");
            const formData = new URLSearchParams(new FormData(form));

            const subject_ids = formData.getAll("subject_ids");
            const component_ids = formData.getAll("component_ids");
            const layer_ids = formData.getAll("layer_ids").map(x => parseInt(x));
            const min_subject_overlap_count = parseInt(formData.get("min_subject_overlap_count"));

            let component_ids_array = component_ids.map(x => init_data.all_component_ids.indexOf(parseInt(x)));

            const checked = formData.getAll("show_component_ids2");
            const component_ids2 = formData.getAll("component_ids2").map((x,i) => ((checked.indexOf(`${i}`) > -1 && x) ? x.split(',').map(y => parseInt(y)) : []));
            const component_index2 = component_ids2.map(x => x.map(y => init_data.all_component_ids.indexOf(y)));

            let x = parseInt(document.getElementsByName("x")[0].value);
            let y = parseInt(document.getElementsByName("y")[0].value);
            let voxel = parseInt(document.getElementsByName("voxel")[0].value);
            let show_groups = parseInt(document.getElementsByName("show_groups")[0].value)

            return {
                component_ids_array,
                component_ids,
                component_index2,
                subject_ids,
                min_subject_overlap_count,
                layer_ids,
                x,
                y,
                voxel,
                show_groups,
            }
        }

        function add_image(parent, src, w, h) {
            let img = document.createElement("img");
            img.src = src;
            if(w)
                img.width = w;
            if(h)
                img.height = h;
            parent.appendChild(img);
            return img;
        }

        function add_row(parent, component_id) {
            let row = document.createElement("div");

            let title = document.createElement("div");
            title.className = "row_title2";
            let title2 = document.createElement("div");
            title2.innerText = component_id;
            title.appendChild(title2);
            row.appendChild(title);

            parent.appendChild(row);
            for(let i = 1; i < 11; i++) {
                add_image(row, "static_data/component_example_images/" + component_id + "_" + i + ".png", 128, 128);
            }
        }
        window.add_row = add_row

        function update_plot() {
            console.time("Load");
            let form_data = get_form_data();

            if(form_data.show_groups)
                startWorker2(form_data);
            else
                startWorker(form_data);
            //startWorker2(component_index2, subject_ids, min_subject_overlap_count);
            pixelValueInformation();
            toggle_roi();
        }
        document.update_plot = update_plot


        function add_check_box(placeholder, name, index, index2, invert) {
            let label = document.createElement("label");
            let text = document.createElement("span");
            text.innerText = index2 || index;
            let checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.name = name;
            checkbox.value = index;
            checkbox.oninput = update_plot;
            label.title = index;
            if(invert) {
                label.appendChild(checkbox);
                label.appendChild(text);
            }
            else {
                label.appendChild(text);
                label.appendChild(checkbox);
            }
            placeholder.appendChild(label);
            return checkbox;
        }

        let placeholder2 = document.getElementById("layer_ids");
        for (let i of [0, 1, 2, 3, 4]) {
            let checkbox = add_check_box(placeholder2, "layer_ids", i, ['white', 'layerB3', 'layerB2', 'layerB1', 'pial'][i], true);
            checkbox.checked = true;
        }

        let placeholder = document.getElementById("subject_ids");
        for (let i of init_data.subject_ids) {
            let checkbox = add_check_box(placeholder, "subject_ids", i);
            checkbox.checked = true;
        }

        let placeholder_comp = document.getElementById("component_ids");
        for (let i of init_data.all_component_ids) {
            add_check_box(placeholder_comp, "component_ids", i);
        }
        restore_form_from_url();
        if(document.querySelector("[name=show_groups]").value != "0") {
            document.getElementById("box_components").style.display = "none";
            document.getElementById("box_concepts").style.display = "";
        }
        update_plot();

        document.getElementById("btn_select_none").onclick = function() {
            for(let elem of placeholder_comp.querySelectorAll("input"))
                elem.checked = false;
            update_plot();
        }
        document.getElementById("btn_select_all").onclick = function() {
            for(let elem of placeholder_comp.querySelectorAll("input"))
                elem.checked = true;
            update_plot();
        }

        // Initialize panzoom
        const plotImage = document.getElementById("plotImage");
        const panzoom = Panzoom(plotImage, { canvas: true, })
        const parent = plotImage.parentElement
        // No function bind needed
        parent.addEventListener('wheel', panzoom.zoomWithWheel)

        // This demo binds to shift + wheel
        parent.addEventListener('wheel', function(event) {
          if (!event.shiftKey) return
          panzoom.zoomWithWheel(event)
        })


            function updatePointDisplay() {
                        let x = document.getElementsByName("x")[0].value;
            let y = document.getElementsByName("y")[0].value;
            let canvas = document.getElementById("myCanvasPoint");
            let ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.arc(x, y, 4/zoom_scale, 0, 2 * Math.PI, false);
            ctx.rect(0, y, canvas.width, 4/zoom_scale);
            ctx.rect(x, 0, 4/zoom_scale, canvas.height);
            ctx.fillStyle = 'red';
            ctx.fill();
            }
        plotImage.addEventListener('panzoomzoom', (event) => {
            zoom_scale = event.detail.scale;
            updatePointDisplay();
        })

        function pixelValueInformation() {
            let form_data = get_form_data();
            console.log("form_data", form_data.voxel)
            getPixelValue(form_data);
            updatePointDisplay();
        }
        document.pixelValueInformation = pixelValueInformation

        let plotImage2 = document.getElementById("myCanvasPoint");
        plotImage2.addEventListener("click", async function(event) {
            const rect = plotImage2.getBoundingClientRect();

            // Calculate click position as percentage of bounding box dimensions
            const xPercent = ((event.clientX - rect.left) / rect.width) * 100;
            const yPercent = ((event.clientY - rect.top) / rect.height) * 100;
            let x = parseInt(xPercent * 2274 / 100);
            let y = parseInt(yPercent * 1024 / 100);
            document.getElementsByName("x")[0].value = x;
            document.getElementsByName("y")[0].value = y;
            let voxel = await getPixelVoxel(x, y);
            document.set_active_voxel(voxel);
            document.getElementsByName("voxel")[0].value = voxel;

            console.log("pixel clicked", x, y, voxel);

            pixelValueInformation();
            form_to_url(document.querySelector('form'))
        });

        });
    </script>


    <script src="js/numpy_to_js.js"></script>
    <script type="module">
        import * as THREE from 'https://threejsfundamentals.org/threejs/resources/threejs/r132/build/three.module.js';
        import {OrbitControls} from 'https://threejsfundamentals.org/threejs/resources/threejs/r132/examples/jsm/controls/OrbitControls.js';
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x151515);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const dom_elem = document.querySelector("#plot3d");
        const renderer = new THREE.WebGLRenderer({canvas: document.querySelector("#plot3d")});
        document.renderer = renderer;
        document.camera = camera;

        let pt = await loadNpy("static_data/pt_flat.npy");
        let vtx = await loadNpy("static_data/vtx.npy");

        let pt2 = await loadNpy("static_data/pt_inflated.npy");
        let pt3 = await loadNpy("static_data/pt_pia.npy");
        let pt4 = await loadNpy("static_data/pt_wm.npy");

        function addMesh() {
            // Define your points and vertices
            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(new Float32Array(pt.shape[0]*3), 3));
            geometry.setIndex( Array.prototype.slice.call(vtx.data) );
            geometry.setAttribute( 'position', new THREE.BufferAttribute( new Float32Array(pt2.data), 3 ) );

            const material = new THREE.MeshBasicMaterial({vertexColors: true, side: THREE.DoubleSide});
            const mesh = new THREE.Mesh( geometry, material );
            scene.add(mesh);

            let last_shape_index = 100;
            function set_shape(index) {
                last_shape_index = index;
                index /= 100;
                let pt_a = [pt, pt2, pt3, pt4][Math.floor(index)];
                let pt_b = [pt, pt2, pt3, pt4][Math.ceil(index)];
                let f = index % 1;
                let array = mesh.geometry.getAttribute('position').array;
                for (let i = 0; i < array.length; i += 1) {
                    array[i] = pt_a.data[i]*(1-f) + pt_b.data[i] * f;
                }
                mesh.geometry.getAttribute('position').needsUpdate = true;
                update_active_voxel();
            }

            var currentAnimationFrame = null;

            function animateShapeChange(endIndex) {
                let duration = 300;
                let startIndex = last_shape_index;

                // Cancel any ongoing animation
                if (currentAnimationFrame) {
                    cancelAnimationFrame(currentAnimationFrame);
                }

                var startTime = null;

                function animate(time) {
                    // Initialize the start time
                    if (!startTime) {
                        startTime = time;
                    }

                    // Calculate the progress (time elapsed) as a percentage of duration
                    var progress = (time - startTime) / duration;

                    // Clamp progress to [0, 1]
                    progress = Math.min(1, progress);

                    // Calculate the current index based on progress
                    var currentIndex = startIndex + (endIndex - startIndex) * progress;

                    // Call your set_shape function
                    set_shape(currentIndex);
                    document.getElementById("shape").value = currentIndex

                    // Continue animation until progress reaches 1 (100%)
                    if (progress < 1) {
                        currentAnimationFrame = requestAnimationFrame(animate);
                    } else {
                        currentAnimationFrame = null;
                    }
                }

                // Start the animation
                currentAnimationFrame = requestAnimationFrame(animate);
            }

            document.animateShapeChange = animateShapeChange;
            document.set_shape = set_shape;

            function set_mesh_colors(c) {
                mesh.geometry.getAttribute('color').array.set(c);
                mesh.geometry.getAttribute('color').needsUpdate = true;
            }
            document.set_mesh_colors = set_mesh_colors;
            return mesh;
        }
        let mesh = addMesh();

        camera.position.z = 1.5;

        // Set up orbit controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.update();

        // Create a raycaster and a vector to hold the mouse click position
        var raycaster = new THREE.Raycaster();
        var mouse = new THREE.Vector2();

        // Add a click event listener to the canvas
        renderer.domElement.addEventListener('click', onDocumentMouseClick, false);


        // Animation loop
        const animate = () => {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        };

        const material2 = new THREE.MeshBasicMaterial({color: 0xff0000});  // greenish blue
        const cube = new THREE.Mesh(new THREE.BoxGeometry(0.01, 0.01, 0.01), material2);
        cube.position.set(0, 0, 0.5)
        scene.add(cube);

        let lw = 0.005
        const cube2 = new THREE.Mesh(new THREE.BoxGeometry(10, lw, lw), material2);
        cube2.position.set(0, 0, 0.5)
        scene.add(cube2);
        const cube3 = new THREE.Mesh(new THREE.BoxGeometry(lw, 10, lw), material2);
        cube3.position.set(0, 0, 0.5)
        scene.add(cube3);
        const cube4 = new THREE.Mesh(new THREE.BoxGeometry(lw, lw, 10), material2);
        cube4.position.set(0, 0, 0.5)
        scene.add(cube4);

        // Function to handle mouse click event
function onDocumentMouseClick(event) {
    // Calculate mouse position in normalized device coordinates (-1 to +1)
    var canvasBounds = renderer.domElement.getBoundingClientRect();

    // Adjust for canvas position and normalize mouse position to -1 to +1 range
    mouse.x = ((event.clientX - canvasBounds.left) / canvasBounds.width) * 2 - 1;
    mouse.y = - ((event.clientY - canvasBounds.top) / canvasBounds.height) * 2 + 1;

    console.log(onDocumentMouseClick, mouse)

    // Update the picking ray with the camera and mouse position
    raycaster.setFromCamera(mouse, camera);

    // Calculate objects intersecting the picking ray
    var intersects = raycaster.intersectObject(mesh);

    if (intersects.length > 0) {
        // Get the first intersected object
        var intersection = intersects[0];
        console.log(intersects)

        // Get the closest vertex (you can also loop through vertices to find the closest one)
        var vertexIndex = intersection.face.a;
        set_active_voxel(vertexIndex);
        document.getElementsByName("voxel")[0].value = vertexIndex;
        document.pixelValueInformation();
    }
}
let active_voxel = undefined;
function set_active_voxel(vertexIndex) {
    console.log("set_active_voxel", vertexIndex)
    active_voxel = vertexIndex;
    update_active_voxel();
}
document.set_active_voxel = set_active_voxel
function update_active_voxel() {
    let a = mesh.geometry.getAttribute('position').array
    console.log("update_active_voxel", active_voxel, a[active_voxel*3])
    var clickedVertex = a[active_voxel*3];
    var clickedVertex1 = a[active_voxel*3+1];
    var clickedVertex3 = a[active_voxel*3+2];

    cube.position.set(clickedVertex, clickedVertex1, clickedVertex3);
    cube2.position.set(clickedVertex, clickedVertex1, clickedVertex3);
    cube3.position.set(clickedVertex, clickedVertex1, clickedVertex3);
    cube4.position.set(clickedVertex, clickedVertex1, clickedVertex3);
}

        animate();

        function onWindowResize() {
            let container = document.querySelector("#plot3d").parentElement;
            let width = container.clientWidth;
            let height = container.clientHeight;

            // Update camera aspect ratio
            camera.aspect = width / height;
            camera.updateProjectionMatrix();

            // Update renderer size
            renderer.setSize(width, height);
        }
        document.onWindowResize = onWindowResize
        document.onWindowResize();

        // Add a resize event listener
        window.addEventListener('resize', onWindowResize, false);
    </script>
</body>
</html>
